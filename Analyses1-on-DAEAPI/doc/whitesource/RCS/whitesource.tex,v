head	1.1;
access;
symbols;
locks
	jaijeet:1.1; strict;
comment	@% @;


1.1
date	96.06.10.19.35.34;	author jaijeet;	state Exp;
branches;
next	;


desc
@stationary white noise sample generation paper
@


1.1
log
@Initial revision
@
text
@\documentstyle[9pt]{article}
\newcommand{\w}{\omega}
\input{psfig}
\newcommand{\ignore}[1]{}

\begin{document}

\title{Generating continuous-time stationary white noise for circuit simulation
applications}
\author{J.~Roychowdhury \and P.~Feldmann}

\maketitle

\section{Introduction}
\label{sec:intro}
Issues: 1. Stationarity, 2. Whiteness, 3. Ergodicity, 4. ramp-up time
	to asymptotic stationary value, 5. gaussianness.
	
What the problem is, why it is important (eg, utility for verifying theories
and algorithms for cyclostationary noise), who needs it, (ideally) previous
work. 

What we propose - motivation in terms of i.i.d r.v.s at every timepoint,
why this is dangerous - what is the PSD function, is it dependent on the
vagaries of the simulator's integration algorithm and timestep control,
is it stationary - we answer these questions, provide a simple procedure for
generating stationary white noise with flat PSD upto any desired frequency,
provide precise formulae for the PSD and autocorrelation functions. Easy to
implement in any circuit simulator, we give a step-by-step procedure for
designing your own stationary noise source.

Paper organization: The model and theoretical analysis using cyclostationary
noise concepts, choice of parameters and numerical calculations,
verification against Monte-Carlo, conclusion.

\section{Generating Stationary White Noise in the Time Domain -- Theory}
\label{sec:theory}
The noise source is generated by linear interpolation of a uniformly spaced
sequence of independent Gaussian sources each of variance 1. The spacing
between the sources is T.

\ignore{
It is immediate that the autocorrelation function
of this sequence is a symmetric hat on [-T, T] (going from 0 at -T linearly
to 1 at 0 and down again to 0 at T). The PSD is the Fourier
transform of this function $f(t)$. Note that $f(t)$ is even, and equal to
$1-{t\over T}$ for $0\le t\le T$.

This is:
\begin{eqnarray*}
\int_{-T}^T f(t) e^{j\w t} \, dt & = & 2 \int_0^T f(t) \cos(\w t) \, dt \\
	& = & {2\over\w}\sin(\w T) - {2\over T}\int_0^T t\cos(\w t)\,dt \\
	& = & {2\over\w}\sin(\w T) - {2\over T} {\left[ {t\over\w}\sin(\w t)
	      - {1\over\w}\int\sin(\w t)\,dt \right]}_0^T \\
	& = & {2\over\w}\sin(\w T) - {2\over T} {\left[ {t\over\w}\sin(\w t)
	      + {1\over\w^2}\cos(\w t) \right]}_0^T \\
	& = & {2\over\w}\sin(\w T) - {2\over T} \left[{T\over\w}\sin(\w T)
	      + {1\over\w^2}\cos(\w T)\right] + {2\over \w^2 T}\\
	& = & {2\over\w^2 T}\left[ 1-\cos(\w T)\right]\\
\end{eqnarray*}

Applying L'Hospital's rule, the limit of this as $\w \to 0$ is $T$, as
expected. When plotted, it looks like a sinc as a function  of $\w$. The
value stays substantially flat upto $\w \approx {1\over 10T}$.
Figures~\ref{fig:linear} and~\ref{fig:loglinear} demonstrate this.
\begin{figure}[htbp]
\centerline{\ \psfig{file=inpnoise1.ps,width=0.7\textwidth}}
\caption{}
\label{fig:linear}
\end{figure}
\begin{figure}[htbp]
\centerline{\ \psfig{file=inpnoise2.ps,width=0.7\textwidth}}
\caption{}
\label{fig:loglinear}
\end{figure}

All this is fine but probably of limited use, because the process unfortunately
is not stationary.
}

Consider the autocorrelation function
$R(t,\tau) = E[x(t)x(t+\tau)]$. 
Now $x_1 = x(t) = \left(1-{t\over T}\right)n_1 + {t\over T}n_2$, 
where $n_1$ and $n_2$
are the independent noise sources at time $0$ and $T$. If $t <= T - \tau$,
then $x_2 = \left(1-{t+\tau\over T}\right)n_1 + {t+\tau\over T}n_2$; if $
T-\tau \le t \le T$, $x_2 = \left(1-{t+\tau-T\over T}\right)n_2 +
{t+\tau-T\over T}n_3$. Here $t \in [0,T]$. Then
\[
R(t,\tau) = \cases{ 
	\left(1-{t\over T}\right)\left(1-{t+\tau\over T}\right)
		+ {t\over T}{t+\tau\over T}
			& if $-t\le\tau\le T-t$;\cr
	{t\over T}\left(1-{t+\tau-T\over T}\right)
			& if $T-t\le\tau\le 2T-t$;\cr
	0
			& if $2T-t\le\tau$;\cr
	\left(1-{t\over T}\right)\left(1+{t+\tau\over T}\right)
			& if $-T-t\le\tau\le-t$;\cr
	0
			& if $\tau\le-T-t$.
}
\]
If $\tau$ is fixed, the autocorrelation is
$T$-periodic in $t$. For $0\le t\le T$, fix $\tau$ at a given value, and
rewrite the above to show better the variation with $t$:
\[
R(t,\tau) = \cases{ 
	0
			& if $t\le-T-\tau$;\cr
	\left(1-{t\over T}\right)\left(1+{t+\tau\over T}\right)
			& if $-T-\tau\le t\le-\tau$;\cr
	\left(1-{t\over T}\right)\left(1-{t+\tau\over T}\right)
		+ {t\over T}{t+\tau\over T}
			& if $-\tau\le t\le T-\tau$;\cr
	{t\over T}\left(1-{t+\tau-T\over T}\right)
			& if $T-\tau\le t\le 2T-\tau$;\cr
	0
			& if $2T-\tau\le t$.
}
\]
$R(t,\tau)$ is plotted in Figure~\ref{fig:Rttau} ($T=1$).
\begin{figure}[htbp]
\centerline{\ \psfig{file=Rttau.ps,width=0.7\textwidth}}
\caption{}
\label{fig:Rttau}
\end{figure}

We want to expand $R(t,\tau)$ in a Fourier series in $t$. We are interested
in particular in the DC component of the Fourier series since it is the
stationary component. Hence for a fixed $\tau$, we need to find the average
value of $R(t,\tau)$ over $t \in [0,T]$. To do this, we look at
$R(t,\tau)$ over segments of $\tau$:

\[
R(t,\tau) = \cases{
	0
		& if $\tau<-2T$;\cr
	\cases{
		0 
			& if $0\le t\le-T-\tau$;\cr
		\left(1-{t\over T}\right)\left(1+{t+\tau\over T}\right)
			& if $-T-\tau\le t\le T$.
	} 
		& if $-2T\le\tau\le-T$; \cr
	\cases{
		\left(1-{t\over T}\right)\left(1+{t+\tau\over T}\right)
			& if $0\le t\le -\tau$;\cr
		\left(1-{t\over T}\right)\left(1-{t+\tau\over
					T}\right)+{t\over T}{t+\tau\over T}
			& if $-\tau\le t\le T$.
	} 
		& if $-T\le\tau\le 0$; \cr
	\cases{
		\left(1-{t\over T}\right)\left(1-{t+\tau\over
					T}\right)+{t\over T}{t+\tau\over T}
			& if $0\le t\le T-\tau$;\cr
		{t\over T}\left(1-{t+\tau-T\over T}\right)
			& if $T-\tau\le t\le T$.
	} 
		& if $0\le\tau\le T$; \cr
	\cases{
		{t\over T}\left(1-{t+\tau-T\over T}\right)
			& if $0\le t\le 2T-\tau$;\cr
		0
			& if $2T-\tau\le t\le T$.
	} 
		& if $T\le\tau\le 2T$; \cr
	0
		& if $\tau \ge 2T$.
}
\]

Taking the average over $t \in [0,T]$, we get
\[
R_0(\tau) = \cases{
	0
		& if $\tau<-2T$;\cr
	{1\over T}\left( {\frac {12\,\tau\,T^{2}+8\,T^{3}+6\,
				T\tau^{2}+\tau^{3}}{6\,T^{2}}}\right)
		& if $-2T\le\tau\le-T$; \cr
	{1\over T}\left( -{\frac {\tau\,\left (6\,T^{2}+\tau^{2}+6\,
				T\tau\right )}{6\,T^{2}}} + 
				{\frac {2\,T^{3}-\tau^{3}+3\,\tau\,T^{2}}
				{3\,T^{2}}} \right)
		& if $-T\le\tau\le 0$; \cr
	{1\over T}\left( {\frac {2\,T^{3}-3\,\tau\,T^{2}+\tau^{3}}{3\,T^{2}}}+
				{\frac {\tau\,\left (6\,T^{2}-6\,T\tau+
				\tau^{2}\right)}{6\,T^{2}}} \right)
		& if $0\le\tau\le T$; \cr
	{1\over T}{\frac {\left (2\,T-\tau\right)^{3}}{6\,T^{2}}}
		& if $T\le\tau\le 2T$; \cr
	0
		& if $\tau \ge 2T$.
}
\]
This function is plotted in Figure~\ref{fig:R0tau} ($T=1$):
\begin{figure}[htbp]
\centerline{\ \psfig{file=R0tau.ps,width=0.7\textwidth}}
\caption{}
\label{fig:R0tau}
\end{figure}
The stationary power spectral density $S_0(\w)$ is the Fourier transform of
$R_0(\tau)$, given by:
\[
S_0(\w) =
-{\frac {8\,\cos(T\omega)-2\,\cos(2\,T\omega)-6}{\omega^{4}T^{3}}}
\]
As $\w\to0$, $S_0(\w)\to T$. $S_0(\w)$ for $T=1$ns is shown in
Figures~\ref{fig:S0loglin} and~\ref{fig:S0linear}.
\begin{figure}[htbp]
\centerline{\ \psfig{file=S0loglin.ps,width=0.7\textwidth}}
\caption{}
\label{fig:S0loglin}
\end{figure}
\begin{figure}[htbp]
\centerline{\ \psfig{file=S0linear.ps,width=0.7\textwidth}}
\caption{}
\label{fig:S0linear}
\end{figure}
The crucial observation is that if this cyclostationary source is sent
through a low-pass filter of bandwidth less that $1\over 2T$, then all
higher-order PSDs $S_i, i\ne 0$ will be completely killed and only $S_0$
will be passed. Hence the output noise will be stationary, and {\em if the
filter bandwidth is less than $1\over 100T$ or so, the cyclostationary
source will look like a stationary white noise source with a flat PSD of
$T$}.

\section{Numerical Calculations}
\label{sec:numcalc}
For a current source of unit variance feeding a resistor in parallel with a
capacitor, we have $H(s) = {R\over 1+sRC}$, $H(f) = {R\over 1+j2\pi fRC}$.
$\int \left| H(f) \right|^2 \,df= {R\over 2\pi C}\tan^{-1}(2\pi R C f)$,
hence $\int_{-\infty}^{\infty} \left| H(f) \right|^2 \,df = {R\over 2 C}$.
Thus the variance of the voltage generated is approximately $R T \over 2 C$
- this is an upper bound.

More accurately, we have
\begin{eqnarray}
\label{eq:whitesourcevariance}
R_0(0) & = & \int_{-\infty}^\infty \left|H(f)\right|^2 S_0(f) \, df \nonumber \\
       & = & - \int_{-\infty}^\infty \left|{R\over 1+j2\pi fRC}\right|^2 {\frac
       {8\,\cos(2\pi f T)-2\,\cos(4\pi f T)-6}{{(2\pi f)}^{4}T^{3}}} \, df
       \nonumber\\
       & = & - \int_{-\infty}^\infty {R^2\over 1+4\pi^2 f^2R^2C^2}{\frac
       {8\,\cos(2\pi f T)-2\,\cos(4\pi f T)-6}{{(2\pi f)}^{4}T^{3}}} \, df 
\end{eqnarray}

This integral is difficult to evaluate analytically (i.e., {\sf maple} has
trouble) so we have to resort to numerical integration for given values of
$R$, $C$ and $T$. For the mixer and filter combination circuit in 
{\sf doc/noise/montecarlo/mixerfilter}, the following values are used:
\[
R=1\Omega, \qquad C=5\mu F,\qquad T=1\mu s
\]
The RC pole is at $200\over 2\pi$KHz. The square of the transfer function
magnitude is shown in Fig.~\ref{fig:magH2}.
\begin{figure}[htbp]
\centerline{\ \psfig{file=magH2.ps,width=0.7\textwidth}}
\caption{}
\label{fig:magH2}
\end{figure}
The integrand of Equation~\ref{eq:whitesourcevariance} is shown in
Figure~\ref{fig:}. When integrated numerically  over the interval $[-10^7,
10^7]$ (using {\sf maple}), we get a result of 0.0912 for $R_0(0)$, the
stationary variance. The upper-bound $R T \over 2 C$ equals 0.1;
hence we see that in this case, the rolloff of $S_0(\w)$ makes a difference of
about 10\% to the variance.

\section{Verification against Monte-Carlo Simulations}
\label{sec:montecarlo}

Brute-force Monte-Carlo simulations were performed in order the verify the
above predictions. The Monte-Carlo simulations were designed to estimate, as
a function of time, the variance of the output noise generated by passing a
linearly interpolated comb of i.i.d gaussian random variables of unit
variance, with comb spacing T, through an RC filter. Two basic approaches
were taken to simulating this system: 1. solving the differential equation
numerically using a general-purpose numerical integration method, and 2.
using the fact that the differential equation for a RC network driven by a
PWL current source can be integrated analytically, and applying the formulae
thus obtained. The values of R, C and T were the same as in
Section~\ref{sec:numcalc}.

The first approach, solving the differential equation numerically, was tried
using the internal circuit simulator ADVICE. A sample size of 10,000 input
waveforms was chosen initially, each extending to a length of 5 RC
time-constants (200us). This translated to an execution time of
about 1 month on a Sun SparcStation 20; this being impractical, the sample
size was reduced to 1000 and the simulations were completed in three days.
The outputs were postprocessed to obtain the noise variances. The variances
of the PWL current source and the filtered output voltage, plotted over a
period $30T$ at the end of the simulation, are shown in
Figures~\ref{fig:iin-rc-advice} and~\ref{fig:v1-rc-advice}. The
cyclostationary change of the variance of the input current source, between
1.0 and 0.5, can be seen in Figure~\ref{fig:iin-rc-advice}; it
is also evident, from Figure~\ref{fig:v1-rc-advice}, that no such
cyclostationary variation exists for filtered output voltage variance, which
wanders between approximately 0.086 and 0.1 on a scale much coarser than
T=1us.  (The circuit and results for this experiment are in
{\sf doc/noise/montecarlo/mixerfilter-advice}.)

\begin{figure}[htbp]
\centerline{\ \psfig{file=iin-rc-advice.ps,width=0.7\textwidth}}
\caption{1000 ADVICE simulations: variance of input current source wrt time}
\label{fig:iin-rc-advice}
\end{figure}
\begin{figure}[htbp]
\centerline{\ \psfig{file=v1-rc-advice.ps,width=0.7\textwidth}}
\caption{1000 ADVICE simulations: variance of RC-filtered output voltage wrt time}
\label{fig:v1-rc-advice}
\end{figure}

Since the 1000 samples in the experiment above were not enough to verify
conclusively the theoretically predicted output noise variance of 0.0912
(from Section~\ref{sec:numcalc}), 10000 samples were tried next. To avoid
the excessive computation time needed by ADVICE, a custom program was
written in C/C++ to perform numerical integration of the circuit's
differential equation. A fourth-order Runge-Kutta method (implemented in the
Numerical Recipes routine {\sf odeint}) was used. The simulation took about
10 hours of computer time. The variances of the input current and output
filtered voltage, as functions of time, are shown in
Figures~\ref{fig:iin-odeint-rc},~\ref{fig:v1-odeint-rc-wide}
and~\ref{fig:v1-odeint-rc-narrow}. It can be seen that the output variance
is stationary, at a value between about 0.088 and 0.095, or centered around
0.0915, close to the predicted value of 0.0912.

\begin{figure}[htbp]
\centerline{\ \psfig{file=iin-odeint-rc.ps,width=0.7\textwidth}}
\caption{10000 {\sf odeint} simulations: variance of input current source wrt time}
\label{fig:iin-odeint-rc}
\end{figure}
\begin{figure}[htbp]
\centerline{\ \psfig{file=v1-odeint-rc-wide.ps,width=0.7\textwidth}}
\caption{10000 {\sf odeint} simulations: variance of RC-filtered output voltage wrt time}
\label{fig:v1-odeint-rc-wide}
\end{figure}
\begin{figure}[htbp]
\centerline{\ \psfig{file=v1-odeint-rc-narrow.ps,width=0.7\textwidth}}
\caption{10000 {\sf odeint} simulations: variance of RC-filtered output
		voltage wrt time (detail)}
\label{fig:v1-odeint-rc-narrow}
\end{figure}

To obtain a more precise estimate, the number of sample waveforms was
increased to 100000. In order to reduce the simulation time and increase
accuracy of results, the second approach mentioned above was tried.  A
program based on analytic expressions for the ODE solution when excited with
a PWL source, was used (the code is in {\sf doc/noise/montecarlo/rc-in-c++}).
This program took about 30 minutes to execute. The input and output
variances are shown in Figures~\ref{fig:iin-analytic-rc}
and~\ref{fig:v1-analytic-rc}. The output variance is again stationary,
between about 0.090 and 0.0925, or centered around 0.0915, again close to
the predicted value of 0.0912.

\begin{figure}[htbp]
\centerline{\ \psfig{file=iin-analytic-rc.ps,width=0.7\textwidth}}
\caption{100000 analytic simulations: variance of input current source wrt time}
\label{fig:iin-analytic-rc}
\end{figure}
\begin{figure}[htbp]
\centerline{\ \psfig{file=v1-analytic-rc.ps,width=0.7\textwidth}}
\caption{100000 analytic simulations: variance of RC-filtered output voltage wrt time}
\label{fig:v1-analytic-rc}
\end{figure}

The above Monte-Carlo experiments verify the stationarity of the output
noise and provide a figure for the stationary noise variance that is
consistent with the theory of the previous sections. Another important
property of stationary processes is {\em ergodicity},
i.e., the condition that time-averages of each sample of the stationary
process equal ensemble averages at any time. 
To verify ergodicity, simulations using the analytic formulae were carried out 
for a length of about 40000 RC time-constants and the average power at the
output of the filter
computed\footnote{Note that a simulation of many times the RC time constant,
i.e., the time-period of correlation in the process, is necessary to obtain
results meaningful for ergodicity.}. Values for this average power from 5
runs (5 samples from the ensemble) were 0.09128, 0.09124, 0.09114, 0.09110
and 0.09104, matching closely the value predicted by theory in
Section~\ref{sec:numcalc} and the ensemble-average variance obtained from
Monte-Carlo simulation.
% more: 0.0916, 0.0910, 0.0914, 0.0913, 0.0914, 0.09096

\section{Conclusion}

\subsection*{Acknowledgments}
Venu, Takis, Mihai

\end{document}
@
